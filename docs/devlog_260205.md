# Lottochu ê°œë°œ ì¼ì§€ - 2026.02.05

## ì˜¤ëŠ˜ì˜ ëª©í‘œ
- ì—°ê¸ˆë³µê¶Œ720+ ê¸°ëŠ¥ ì¶”ê°€
- DB êµ¬ì¡°: ë³µê¶Œë³„ í…Œì´ë¸” ë¶„ë¦¬
- ì½”ë“œ êµ¬ì¡°: ì—°ê¸ˆ ì „ìš© ëª¨ë“ˆ ë¶„ë¦¬
- ì—°ê¸ˆ API ì—°ë™ ë° ìŠ¤ì¼€ì¤„ëŸ¬Â·Telegram í™•ì¥

---

## DB êµ¬ì¡° â€” ë³µê¶Œë³„ í…Œì´ë¸” ë¶„ë¦¬

### ê²°ì • ì‚¬í•­
- **ë¡œë˜**: í…Œì´ë¸”ëª… ë³€ê²½ â€” `draws` â†’ `lotto_draws`, `recommendations` â†’ `lotto_recommendations`, `results` â†’ `lotto_results`
- **ì—°ê¸ˆ**: ì „ìš© í…Œì´ë¸” (`pension_draws`, `pension_recommendations`, `pension_results`)

### ë¡œë˜ í…Œì´ë¸”ëª… ë³€ê²½ (ë§ˆì´ê·¸ë ˆì´ì…˜)

| ê¸°ì¡´ í…Œì´ë¸”ëª… | ë³€ê²½ í›„ |
|---------------|---------|
| draws | lotto_draws |
| recommendations | lotto_recommendations |
| results | lotto_results |

- ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸: `docs/migrations/rename-lotto-tables.sql`
- **ì‹¤í–‰ ë°©ë²•**: PostgreSQL ì‹¤í–‰ í›„, ì•± ì¤‘ì§€ â†’ `psql -U postgres -d lottochu -f docs/migrations/rename-lotto-tables.sql` ì‹¤í–‰ â†’ ì•± ì¬ì‹œì‘
- ì—”í‹°í‹° `@Entity()` ë° í†µê³„ ì„œë¹„ìŠ¤ raw SQL(`lotto_draws`) ë°˜ì˜ ì™„ë£Œ

### pension_draws

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì„¤ëª… |
|--------|------|------|
| id | integer (PK) | íšŒì°¨ ë²ˆí˜¸ |
| draw_date | date | ì¶”ì²¨ì¼ (nullable) |
| group_no | integer | 1ë“± ì¡° ë²ˆí˜¸ 1~5 (nullable, API ë¯¸ì œê³µ) |
| digits | varchar(6) | 1ë“± 6ìë¦¬ ë²ˆí˜¸ (nullable, API ë¯¸ì œê³µ) |
| prize_1st ~ prize_8th | bigint | 1~8ë“± ë‹¹ì²¨ê¸ˆ |
| winners_1st ~ winners_8th | integer | 1~8ë“± ë‹¹ì²¨ì ìˆ˜ |
| created_at | timestamp | ìˆ˜ì§‘ ì‹œê° |

### pension_recommendations

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì„¤ëª… |
|--------|------|------|
| id | uuid (PK) | ê³ ìœ  ID |
| target_draw_id | integer | ëŒ€ìƒ íšŒì°¨ |
| type | enum | STATISTICAL / AI |
| game_number | integer | ê²Œì„ ë²ˆí˜¸ (1~5) |
| group_no | integer | ì¡° ë²ˆí˜¸ (1~5) |
| digits | varchar(6) | 6ìë¦¬ ë²ˆí˜¸ |
| ai_reasoning | text | AI ì¶”ì²œ ê·¼ê±° (nullable) |
| created_at | timestamp | ìƒì„± ì‹œê° |

### pension_results

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì„¤ëª… |
|--------|------|------|
| id | uuid (PK) | ê³ ìœ  ID |
| recommendation_id | uuid (FK) | ì¶”ì²œ ID |
| prize_rank | integer | ë‹¹ì²¨ ë“±ìˆ˜ (1~8), null = ë‚™ì²¨ |
| created_at | timestamp | ìƒì„± ì‹œê° |

---

## ì½”ë“œ êµ¬ì¡° â€” ì—°ê¸ˆ ì „ìš© ëª¨ë“ˆ (libs/pension)

### ë””ë ‰í„°ë¦¬ êµ¬ì¡°
```
libs/pension/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ domain/entities/     # PensionDraw, PensionRecommendation, PensionResult
â”‚       â”œâ”€â”€ infrastructure/repositories/
â”‚       â”œâ”€â”€ application/commands/ # Sync, GenerateRecommendation, CheckResults
â”‚       â”œâ”€â”€ interfaces/          # PensionController
â”‚       â””â”€â”€ pension.module.ts
â”œâ”€â”€ project.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ tsconfig.lib.json
```

### CQRS ëª…ë ¹
| Command | Handler | ì„¤ëª… |
|---------|---------|------|
| SyncPensionDrawsCommand | SyncPensionDrawsHandler | ë‹¹ì²¨ ë°ì´í„° ë™ê¸°í™” |
| GeneratePensionRecommendationCommand | GeneratePensionRecommendationHandler | ì¶”ì²œ ë²ˆí˜¸ ìƒì„± (í†µê³„ 3 + AI 2) |
| CheckPensionResultsCommand | CheckPensionResultsHandler | ë‹¹ì²¨ ê²°ê³¼ ë¹„êµÂ·ì €ì¥ |

### REST API (PensionController)
| Method | Path | ì„¤ëª… |
|--------|------|------|
| POST | /pension/sync | ë™ê¸°í™” (query: start, end). **ì—­ëŒ€ ì „ë¶€**: `?start=1` ë¡œ 1íšŒì°¨~ìµœì‹ íšŒì°¨ ì €ì¥ |
| GET | /pension/draws | ì „ì²´ íšŒì°¨ ì¡°íšŒ |
| GET | /pension/draws/latest | ìµœì‹  íšŒì°¨ ì¡°íšŒ |
| GET | /pension/status | ë™ê¸°í™” ìƒíƒœ |
| POST | /pension/recommend | ì¶”ì²œ ìƒì„± (query: draw) |

- **ì—°ê¸ˆ ì—­ëŒ€ ë°ì´í„° ì „ë¶€ DB ì €ì¥**: `POST /pension/sync?start=1` í˜¸ì¶œ ì‹œ 1íšŒì°¨ë¶€í„° API ìµœì‹  íšŒì°¨ê¹Œì§€ ë™ê¸°í™”(ì´ë¯¸ ìˆëŠ” íšŒì°¨ëŠ” ìŠ¤í‚µ). end ë¯¸ì§€ì • ì‹œ APIì—ì„œ ìµœì‹  íšŒì°¨ ìë™ ì¡°íšŒ.

---

## ì—°ê¸ˆ API ì—°ë™

### ì‚¬ìš© API
```
https://www.dhlottery.co.kr/pt720/selectPstPt720WnInfo.do?srchPsltEpsd={íšŒì°¨}
```

- **íšŒì°¨ë³„ í˜¸ì¶œë§Œ ì§€ì›** (`srchPsltEpsd=all` ë¯¸ì§€ì›)
- ì‘ë‹µ: 1~8ë“±(wnRnk) ë‹¹ì²¨ê¸ˆ(totAmt), ë‹¹ì²¨ì ìˆ˜(wnTotalCnt)
- **1ë“± ë‹¹ì²¨ë²ˆí˜¸(ì¡°+6ìë¦¬)ëŠ” API ë¯¸ì œê³µ** â†’ `group_no`, `digits` nullable

### DhPensionClient (libs/shared)

| ë©”ì„œë“œ | ì„¤ëª… |
|--------|------|
| getDrawResult(episode) | íŠ¹ì • íšŒì°¨ ë‹¹ì²¨ ì •ë³´ ì¡°íšŒ |
| getLatestDrawId() | ìµœì‹  íšŒì°¨ ë²ˆí˜¸ íƒìƒ‰ (íšŒì°¨ ì¦ê°€í•˜ë©° ì¡°íšŒ) |
| getDrawRange(start, end) | íšŒì°¨ ë²”ìœ„ ì¡°íšŒ (200ms ê°„ê²©) |

### íŒŒì‹± ì¸í„°í˜ì´ìŠ¤
```typescript
interface PensionDrawInfo {
  drawId: number;
  drawDate: Date | null;
  groupNo: number | null;
  digits: string | null;
  prizes: (number | null)[];   // 1~8ë“±
  winners: (number | null)[];
}
```

---

## ìŠ¤ì¼€ì¤„ëŸ¬ í™•ì¥

### ë¡œë˜ (ê¸°ì¡´ ìœ ì§€)
| Cron | ì‹œê°„ | ì‘ì—… |
|------|------|------|
| 30 12 * * 1 | ì›”ìš”ì¼ 12:30 | ë¡œë˜ ì¶”ì²œ ìƒì„± â†’ Telegram ë°œì†¡ |
| 0 22 * * 6 | í† ìš”ì¼ 22:00 | ë¡œë˜ ê²°ê³¼ í™•ì¸ â†’ Telegram ë°œì†¡ |
| 30 22 * * 6 | í† ìš”ì¼ 22:30 | ë¡œë˜ í†µê³„(DB) ê°±ì‹  |

### ì—°ê¸ˆ (ì‹ ê·œ)
| Cron | ì‹œê°„ | ì‘ì—… |
|------|------|------|
| 30 12 * * 1 | ì›”ìš”ì¼ 12:30 | ì—°ê¸ˆ ì¶”ì²œ ìƒì„± â†’ Telegram ë°œì†¡ |
| 0 22 * * 4 | **ëª©ìš”ì¼ 22:00** | ì—°ê¸ˆ ê²°ê³¼ í™•ì¸ â†’ Telegram ë°œì†¡ |
| 30 12 * * 5 | **ê¸ˆìš”ì¼ 12:30** | ì—°ê¸ˆ DB(í†µê³„) ê°±ì‹  |

- ì—°ê¸ˆ ê²°ê³¼ëŠ” ëª©ìš”ì¼ ë°œí‘œ â†’ ê²°ê³¼ ìŠ¤ì¼€ì¤„ ëª©ìš”ì¼ 22:00
- ì—°ê¸ˆ í†µê³„ ê°±ì‹ ì€ ê¸ˆìš”ì¼ 12:30ìœ¼ë¡œ ë¶„ë¦¬

---

## Telegram ì—°ê¸ˆ ë©”ì‹œì§€

### ì¶”ê°€ íƒ€ì…
- `PensionRecommendationMessage`: targetDrawId, drawDate, statistical( groupNo, digits ), ai( groupNo, digits, reasoning )
- `PensionResultMessage`: drawId, winningGroupNo, winningDigits, results( gameNumber, type, groupNo, digits, prizeRank )

### ì¶”ê°€ ë©”ì„œë“œ
- `sendPensionRecommendation(data)` â€” ì—°ê¸ˆ ì¶”ì²œ í¬ë§· í›„ ì „ì†¡
- `sendPensionResult(data)` â€” ì—°ê¸ˆ ë‹¹ì²¨ ê²°ê³¼ í¬ë§· í›„ ì „ì†¡

### ë©”ì‹œì§€ í¬ë§· ì˜ˆì‹œ
```
ğŸ± 298íšŒ ì—°ê¸ˆë³µê¶Œ720+ ì¶”ì²œ

ğŸ“Š í†µê³„ ê¸°ë°˜:
1ï¸âƒ£ 3ì¡° 112703
2ï¸âƒ£ 1ì¡° 456789
...

ğŸ¤– AI ì¶”ì²œ:
4ï¸âƒ£ 5ì¡° 234567
   â”” ì—°ê¸ˆë³µê¶Œ ëœë¤ ì¶”ì²œ (AI í™•ì¥ ì‹œ êµì²´)

ğŸ“… ì¶”ì²¨ì¼: ...
```

---

## ì—°ê¸ˆ ë‹¹ì²¨ ë“±ìˆ˜ ê³„ì‚°

- **1ë“±**: ì¡° + 6ìë¦¬ ì „ë¶€ ì¼ì¹˜
- **2~7ë“±**: ë Nìë¦¬ ì¼ì¹˜ (2ë“±=ë5ìë¦¬, 3ë“±=ë4ìë¦¬, â€¦, 7ë“±=ë1ìë¦¬)
- ë‹¹ì²¨ë²ˆí˜¸(`group_no`, `digits`) ë¯¸ë“±ë¡ ì‹œ ë¹„êµ ë¶ˆê°€ â†’ ê²°ê³¼ null

---

## ìˆ˜ì •Â·ì¶”ê°€ëœ íŒŒì¼ ëª©ë¡

| íŒŒì¼ ê²½ë¡œ | ë³€ê²½ ë‚´ìš© |
|-----------|----------|
| `libs/pension/*` | ì—°ê¸ˆ ëª¨ë“ˆ ì „ë¶€ ì‹ ê·œ (ì—”í‹°í‹°, Repository, CQRS, Controller, Module) |
| `libs/lotto/.../draw.entity.ts` | `@Entity('lotto_draws')` ë¡œ í…Œì´ë¸”ëª… ë³€ê²½ |
| `libs/lotto/.../recommendation.entity.ts` | `@Entity('lotto_recommendations')` ë¡œ í…Œì´ë¸”ëª… ë³€ê²½ |
| `libs/lotto/.../result.entity.ts` | `@Entity('lotto_results')` ë¡œ í…Œì´ë¸”ëª… ë³€ê²½ |
| `libs/statistics/.../statistics.service.ts` | raw SQL `FROM draws` â†’ `FROM lotto_draws` |
| `docs/migrations/rename-lotto-tables.sql` | ì‹ ê·œ â€” ë¡œë˜ í…Œì´ë¸”ëª… ë³€ê²½ ë§ˆì´ê·¸ë ˆì´ì…˜ |
| `libs/shared/src/lib/clients/dh-pension.client.ts` | ì‹ ê·œ â€” ì—°ê¸ˆ API í´ë¼ì´ì–¸íŠ¸ |
| `libs/shared/src/lib/clients/index.ts` | DhPensionClient export ì¶”ê°€ |
| `libs/shared/src/lib/shared.module.ts` | DhPensionClient ë“±ë¡Â·export |
| `libs/telegram/src/lib/telegram.service.ts` | PensionRecommendationMessage, PensionResultMessage, sendPensionRecommendation, sendPensionResult ì¶”ê°€ |
| `libs/scheduler/src/lib/scheduler.module.ts` | PensionModule import ì¶”ê°€ |
| `libs/scheduler/src/lib/scheduler.service.ts` | ì—°ê¸ˆ ì¶”ì²œ/ê²°ê³¼/í†µê³„ Cron 3ê°œ ì¶”ê°€, ë¡œë˜ Cron ì´ë¦„ ì •ë¦¬ |
| `apps/api/src/app.module.ts` | PensionModule import ì¶”ê°€ |
| `tsconfig.base.json` | `@lottochu/pension` path ì¶”ê°€ |

---

## ì°¸ê³  ì‚¬í•­

- ì—°ê¸ˆ 1ë“± ë‹¹ì²¨ë²ˆí˜¸(ì¡°+6ìë¦¬)ëŠ” í˜„ì¬ APIì—ì„œ ì œê³µí•˜ì§€ ì•ŠìŒ. ì¶”í›„ ë™í–‰ ì‚¬ì´íŠ¸ ë‚´ë¶€ APIÂ·ìˆ˜ë™ ì…ë ¥Â·CSV ë“±ìœ¼ë¡œ ë³´ê°• ì‹œ ê²°ê³¼ ë¹„êµê°€ ì •ìƒ ë™ì‘í•¨.
- ì—°ê¸ˆ ì¶”ì²œì€ í˜„ì¬ í†µê³„/AI ëª¨ë‘ ëœë¤ ìƒì„±(ì¡° 1~5, 6ìë¦¬). ì—°ê¸ˆ ì „ìš© í†µê³„Â·AI í”„ë¡¬í”„íŠ¸ í™•ì¥ ì‹œ êµì²´ ê°€ëŠ¥.
