# Lottochu 개발 일지 - 2026.02.04

## 오늘의 목표
- 동행복권 API 연동 문제 해결
- 전체 로또 데이터 동기화
- 데이터베이스 구조 확장 (2등/3등 정보 추가)

---

## API 엔드포인트 변경

### 문제 상황
- 기존 API (`dhlottery.co.kr/common.do?method=getLottoNumber`)가 HTML 반환
- JSON 데이터를 받을 수 없어 동기화 실패

### 해결 방법
- 새로운 공식 API 엔드포인트 발견 및 적용:
```
https://www.dhlottery.co.kr/lt645/selectPstLt645Info.do?srchLtEpsd=all
```

| 시간 | 작업 내용 | 상태 |
|------|----------|------|
| 00:05 | 새 API 엔드포인트 테스트 | ✅ |
| 00:06 | DhLotteryClient 전면 리팩토링 | ✅ |
| 00:07 | 새 API 응답 인터페이스 정의 | ✅ |
| 00:08 | 캐시 시스템 추가 (1시간 유효) | ✅ |

### 새 API 응답 구조
```typescript
interface DhLotteryDrawData {
  ltEpsd: number;      // 회차
  tm1WnNo ~ tm6WnNo;   // 당첨번호 1~6
  bnsWnNo: number;     // 보너스 번호
  ltRflYmd: string;    // 추첨일 (YYYYMMDD)
  rnk1WnAmt: number;   // 1등 당첨금
  rnk1WnNope: number;  // 1등 당첨자 수
  rnk2WnAmt: number;   // 2등 당첨금
  rnk2WnNope: number;  // 2등 당첨자 수
  rnk3WnAmt: number;   // 3등 당첨금
  rnk3WnNope: number;  // 3등 당첨자 수
}
```

### 장점
- 한 번의 API 호출로 **전체 회차** 데이터 조회 가능
- 기존: 회차별 개별 호출 필요 (1,209회 × API 호출)
- 신규: 1회 호출로 전체 데이터 수신

---

## 데이터베이스 스키마 확장

### 추가된 컬럼 (draws 테이블)

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| prize_2nd | bigint | 2등 당첨금 |
| winners_2nd | integer | 2등 당첨자 수 |
| prize_3rd | bigint | 3등 당첨금 |
| winners_3rd | integer | 3등 당첨자 수 |

| 시간 | 작업 내용 | 상태 |
|------|----------|------|
| 00:08 | Draw 엔티티에 2등/3등 컬럼 추가 | ✅ |
| 00:09 | DhLotteryClient에 2등/3등 파싱 추가 | ✅ |
| 00:10 | SyncDrawsHandler 매핑 함수 업데이트 | ✅ |
| 00:10 | TypeORM 자동 스키마 동기화 확인 | ✅ |

### 최종 draws 테이블 구조
```sql
                      "public.draws" 테이블
   컬럼명       |             타입              | NULL 허용 | 기본값 
---------------+-----------------------------+-----------+--------
 id            | integer                     | not null  | 
 draw_date     | date                        | not null  | 
 numbers       | integer[]                   | not null  | 
 bonus_number  | integer                     | not null  | 
 prize_1st     | bigint                      |           | 
 winners_1st   | integer                     |           | 
 prize_2nd     | bigint                      |           | 
 winners_2nd   | integer                     |           | 
 prize_3rd     | bigint                      |           | 
 winners_3rd   | integer                     |           | 
 created_at    | timestamp without time zone | not null  | now()
```

---

## 데이터 동기화 완료

| 시간 | 작업 내용 | 상태 |
|------|----------|------|
| 00:11 | 서버 재시작 | ✅ |
| 00:12 | `/lotto/sync` API 호출 | ✅ |
| 00:13 | 전체 데이터 동기화 완료 | ✅ |

### 동기화 결과

| 항목 | 값 |
|------|-----|
| 총 회차 | **1,209회** |
| 첫 회차 | 1회 (2002-12-07) |
| 최신 회차 | 1,209회 (2026-01-31) |
| 소요 시간 | 약 15초 |

### 최신 5개 회차 데이터 확인
```
  회차  |  추첨일     |      당첨번호        | 보너스 |   1등 당첨금   |  2등 당첨금   |  3등 당첨금
-------+------------+---------------------+-------+--------------+--------------+------------
 1209  | 2026-01-31 | {2,17,20,35,37,39}  |  24   | 1,371,910,466 |  68,908,745  |  1,601,509
 1208  | 2026-01-24 | {6,27,30,36,38,42}  |  25   | 5,001,713,625 |  73,554,613  |  1,705,906
 1207  | 2026-01-17 | {10,22,24,27,38,45} |  11   | 1,733,202,949 |  57,101,648  |  1,459,359
 1206  | 2026-01-10 | {1,3,17,26,27,42}   |  23   | 1,868,807,000 |  63,135,372  |  1,403,430
 1205  | 2026-01-03 | {1,4,16,23,31,41}   |   2   | 3,226,386,263 |  55,436,191  |  1,542,545
```

---

## pgAdmin 설정 해결

### 문제 상황
- pgAdmin 4 실행 시 `ModuleNotFoundError: No module named 'pgadmin'` 오류
- PostgreSQL 17 번들 pgAdmin의 Python 환경 문제

### 해결 방법
| 시간 | 작업 내용 | 상태 |
|------|----------|------|
| 00:00 | pgAdmin 설정 폴더 초기화 (`%APPDATA%\pgadmin4` 삭제) | ✅ |
| 00:02 | pgAdmin 재실행 성공 | ✅ |
| 00:03 | lottochu 데이터베이스 확인 | ✅ |
| 00:04 | 테이블 (draws, recommendations, results) 확인 | ✅ |

---

## 수정된 파일 목록

| 파일 경로 | 변경 내용 |
|-----------|----------|
| `libs/shared/src/lib/clients/dhlottery.client.ts` | 새 API 엔드포인트 적용, 캐시 시스템, 2등/3등 파싱 |
| `libs/lotto/src/lib/domain/entities/draw.entity.ts` | prize_2nd, winners_2nd, prize_3rd, winners_3rd 컬럼 추가 |
| `libs/lotto/src/lib/application/commands/sync-draws.handler.ts` | 2등/3등 매핑 추가, 최적화 |

---

## 테이블 컬럼 순서 정리

### 문제 상황
- TypeORM synchronize로 추가된 2등/3등 컬럼이 `created_at` 뒤에 배치됨
- 논리적인 컬럼 순서를 위해 재정렬 필요

### 해결 방법
- PostgreSQL은 컬럼 순서 직접 변경 불가 → 테이블 재생성 방식 사용

| 시간 | 작업 내용 | 상태 |
|------|----------|------|
| 00:20 | 외래키 제약조건 임시 삭제 | ✅ |
| 00:20 | 새 테이블 생성 (올바른 컬럼 순서) | ✅ |
| 00:20 | 데이터 복사 (1,209건) | ✅ |
| 00:20 | 기존 테이블 삭제 및 이름 변경 | ✅ |
| 00:20 | 외래키 제약조건 재생성 | ✅ |

### 변경 전 → 변경 후
```
변경 전:                          변경 후:
 id                               id
 draw_date                        draw_date
 numbers                          numbers
 bonus_number                     bonus_number
 prize_1st                        prize_1st
 winners_1st                      winners_1st
 created_at    ← 여기 있었음      prize_2nd     ← 이동
 prize_2nd                        winners_2nd   ← 이동
 winners_2nd                      prize_3rd     ← 이동
 prize_3rd                        winners_3rd   ← 이동
 winners_3rd                      created_at    ← 맨 뒤로 이동
```

---

## Telegram 봇 설정

| 시간 | 작업 내용 | 상태 |
|------|----------|------|
| 00:25 | BotFather에서 봇 생성 (@lottochu_bot) | ✅ |
| 00:26 | 봇 토큰 및 Chat ID 획득 | ✅ |
| 00:27 | `.env` 파일에 설정 추가 | ✅ |
| 00:28 | 서버 재시작 및 봇 초기화 확인 | ✅ |
| 00:30 | 테스트 메시지 전송 성공 | ✅ |

### 설정된 환경변수
```env
TELEGRAM_BOT_TOKEN=8563341868:AAG...
TELEGRAM_CHAT_ID=6553655200
```

### 봇 기능
- **추천 알림**: 매주 월요일 로또 번호 추천 전송
- **결과 알림**: 매주 토요일 당첨 결과 및 성적 분석 전송
- **단방향 전송**: 설정된 Chat ID로만 메시지 전송

---

## 스케줄러 설정

| 시간 | 작업 내용 | 상태 |
|------|----------|------|
| 00:40 | CheckResultsCommand 생성 | ✅ |
| 00:41 | CheckResultsHandler 구현 (결과 비교 로직) | ✅ |
| 00:42 | RecommendationRepository 생성 | ✅ |
| 00:43 | ResultRepository 생성 | ✅ |
| 00:44 | SchedulerService 업데이트 (결과 체크 완성) | ✅ |
| 00:45 | 빌드 및 서버 시작 테스트 | ✅ |

### 자동 실행 스케줄

| Cron | 시간 | 작업 |
|------|------|------|
| `30 12 * * 1` | 월요일 12:30 | 번호 추천 생성 → Telegram 발송 |
| `0 22 * * 6` | 토요일 22:00 | 결과 체크 → Telegram 발송 |
| `30 22 * * 6` | 토요일 22:30 | 통계 갱신 |

### 당첨 등수 계산 로직

```typescript
if (matchedCount === 6) return 1;           // 1등
if (matchedCount === 5 && hasBonus) return 2; // 2등
if (matchedCount === 5) return 3;           // 3등
if (matchedCount === 4) return 4;           // 4등
if (matchedCount === 3) return 5;           // 5등
return null;                                 // 낙첨
```

---

## Ollama AI 연동

| 시간 | 작업 내용 | 상태 |
|------|----------|------|
| 00:55 | Ollama 설치 확인 | ✅ |
| 00:55 | llama3.2 모델 다운로드 | ✅ |
| 00:56 | `.env` 모델명 수정 (`llama3.2:latest`) | ✅ |

### 설정된 환경변수
```env
OLLAMA_URL=http://localhost:11434
OLLAMA_MODEL=llama3.2:latest
```

### 모델 정보
- **모델**: llama3.2:latest
- **크기**: 3.2B 파라미터
- **양자화**: Q4_K_M
- **용량**: 약 2GB

---

## 외래키 제약조건 수정

### 문제 상황
- 추천은 **미래 회차** (1210회)를 대상으로 생성
- `recommendations.target_draw_id → draws.id` 외래키 제약조건으로 인해 에러 발생
- 아직 존재하지 않는 회차를 참조할 수 없음

### 해결 방법
| 시간 | 작업 내용 | 상태 |
|------|----------|------|
| 00:57 | Recommendation 엔티티에서 ManyToOne 관계 제거 | ✅ |
| 00:57 | Draw 엔티티에서 OneToMany 관계 제거 | ✅ |
| 00:58 | DB 외래키 제약조건 삭제 | ✅ |

### 변경된 파일
| 파일 | 변경 내용 |
|------|----------|
| `libs/lotto/src/lib/domain/entities/recommendation.entity.ts` | ManyToOne, JoinColumn 제거 |
| `libs/lotto/src/lib/domain/entities/draw.entity.ts` | OneToMany 제거 |

---

## 번호 추천 API 테스트

| 시간 | 작업 내용 | 상태 |
|------|----------|------|
| 01:00 | `/lotto/recommend` API 호출 | ✅ |
| 01:00 | 통계 기반 3게임 생성 | ✅ |
| 01:00 | AI 기반 2게임 생성 | ✅ |
| 01:01 | DB 저장 확인 | ✅ |

### 추천 결과 (1210회차)

| 게임 | 타입 | 번호 |
|------|------|------|
| 1 | STATISTICAL | 1, 3, 7, 16, 21, 26 |
| 2 | STATISTICAL | 1, 3, 13, 18, 21, 33 |
| 3 | STATISTICAL | 11, 14, 19, 24, 26, 37 |
| 4 | AI | 14, 20, 23, 25, 29, 33 |
| 5 | AI | 10, 18, 22, 26, 32, 38 |

### AI 추천 특징
- Ollama llama3.2 모델 사용
- 최근 회차 출현 빈도 분석 기반 추천
- 번호 범위별 분포 고려

---

## Telegram 알림 테스트

| 시간 | 작업 내용 | 상태 |
|------|----------|------|
| 01:01 | 1210회차 추천 번호 메시지 전송 | ✅ |
| 01:01 | 수신 확인 완료 | ✅ |

### 전송된 메시지 예시
```
🎰 Lottochu 1210회차 추천 번호

📊 통계 기반 (3게임)
1️⃣ 1, 3, 7, 16, 21, 26
2️⃣ 1, 3, 13, 18, 21, 33
3️⃣ 11, 14, 19, 24, 26, 37

🤖 AI 기반 (2게임)
4️⃣ 14, 20, 23, 25, 29, 33
5️⃣ 10, 18, 22, 26, 32, 38

💰 총 5게임 = 5,000원

🍀 행운을 빕니다!
```

---

## 완료된 작업 요약

| 기능 | 상태 | 비고 |
|------|------|------|
| 로또 데이터 동기화 | ✅ | 1~1209회차 완료 |
| 통계 분석 API | ✅ | 빈도수, 후보번호 제공 |
| 번호 추천 API | ✅ | 통계 3게임 + AI 2게임 |
| Ollama AI 연동 | ✅ | llama3.2 모델 |
| Telegram 알림 | ✅ | 추천/결과 알림 |
| 스케줄러 | ✅ | 월요일 12:30, 토요일 22:00 |

---

## 기술적 배움

### 1. 동행복권 API
- 공식 API는 `selectPstLt645Info.do`로 전체 데이터 조회 가능
- 개별 회차 조회 API는 불안정할 수 있음

### 2. TypeORM synchronize
- 엔티티에 새 컬럼 추가 시 자동으로 DB 스키마 동기화
- 개발 환경에서 유용하지만 프로덕션에서는 migration 권장

### 3. NestJS + Nx
- 모노레포 구조로 라이브러리 간 의존성 관리 용이
- `@lottochu/shared` 등 경로 별칭으로 깔끔한 import
