# Lottochu 개발 일지 - 2026.02.08

## 오늘의 목표
- 연금복권 스케줄 금요일로 통일
- 연금 통계(DB) 갱신 후 텔레그램 알림 추가
- 로또 추천: 통계+AI 모두 만든 뒤 한 번에 저장 (부분 저장 방지)
- Ollama 모델명 통일 (llama3.2:latest)
- 스케줄러: 이미 해당 회차 추천 데이터 있으면 스킵
- 테스트 후 Cron 원래 요일·시간으로 복구

---

## 연금 스케줄 변경

### 변경 요약

| 작업 | 변경 전 | 변경 후 |
|------|---------|---------|
| 다음 회차 연금 추천 생성 후 텔레그램 발송 | 월요일 12:30 (`30 12 * * 1`) | **금요일 12:30** (`30 12 * * 5`) |
| 당첨 데이터 동기화 → 최신 회차 결과 확인 → 텔레그램 발송 | 목요일 22:00 (`0 22 * * 4`) | **금요일 12:00** (`0 12 * * 5`) |
| 연금 당첨 데이터 동기화(통계용 DB 갱신) | 금요일 12:30 (`30 12 * * 5`) | **금요일 13:00** (`0 13 * * 5`) |

### 금요일 실행 순서
1. **12:00** — 당첨 결과 확인 및 텔레그램 발송  
2. **12:30** — 다음 회차 연금 추천 생성 및 텔레그램 발송  
3. **13:00** — 연금 당첨 데이터 동기화(통계용) 후 텔레그램 알림  

---

## 연금 통계 갱신 후 텔레그램 알림

### 추가 동작
- `handlePensionStatisticsUpdate()` 실행 후 `SyncPensionDrawsCommand` 결과(`SyncPensionDrawsResult`)를 받아 텔레그램 메시지 발송
- **새로 반영된 회차가 있으면**: 새로 반영 N건, 회차 목록, 범위( startDrawId ~ endDrawId ) 안내
- **변경 없으면**: "변경 없음 (최신 상태 유지)", 현재 최신 회차 안내

### 메시지 예시
```
🎱 연금 당첨 데이터 동기화 완료

새로 반영: 2건 (회차 301, 302)
범위: 301 ~ 302회
```

---

## 로또 추천 저장 로직 변경

### 문제
- 통계 3건 저장 → AI 2건 생성 중 Ollama에서 막히면 **통계만 여러 번 쌓임** (같은 회차로 중복 행 생성)

### 변경
- **통계 3건 생성(메모리)** → **AI 2건 생성(Ollama)** → **5건 한 번에 DB 저장**
- Ollama 실패 시 DB에 아무것도 넣지 않음 (부분 저장 없음)

| 파일 | 변경 |
|------|------|
| `libs/lotto/.../generate-recommendation.handler.ts` | 통계/AI 모두 만든 뒤 `recommendationRepository.save(toSave)` 한 번에 5건 저장 |

---

## Ollama 모델명 통일

### 원인
- `.env` / 코드 기본값이 `llama3.2:8b`인데, `ollama pull llama3.2` 시 보통 **llama3.2:latest**만 설치됨 → 404 "model not found" → fallback 랜덤 생성

### 변경
- 코드 기본값: `llama3.2:8b` → **`llama3.2:latest`**
- `.env` / `.env.example`: `OLLAMA_MODEL=llama3.2:latest` 로 통일

| 파일 | 변경 |
|------|------|
| `libs/ai/src/lib/ollama.client.ts` | 기본 모델 `llama3.2:latest` |
| `.env.example` | `OLLAMA_MODEL=llama3.2:latest` |
| (운영) `.env` | 동일하게 수정 시 실제 AI 추천 동작 |

---

## 스케줄러: 이미 데이터 있으면 스킵

### 목적
- 수동으로 먼저 추천 생성·발송해 두었을 때, 스케줄 시간에 **중복 생성/발송하지 않도록** 스킵

### 동작
- **로또 추천 Cron**: `targetDrawId`에 대해 `recommendationRepository.findByDrawId(targetDrawId)` 조회 → 1건이라도 있으면 로그만 남기고 return (생성·발송 안 함)
- **연금 추천 Cron**: `pensionRecommendationRepository.findByDrawId(targetDrawId)` 조회 → 1건이라도 있으면 동일하게 스킵

### 로그 예시
```
⏭️ Draw #1211 already has 5 recommendations, skipping
⏭️ Pension draw #302 already has 5 recommendations, skipping
```

### Cron 복구 (테스트 완료 후)
- 로또 추천: **월요일 12:30** (`30 12 * * 1`)
- 연금 추천: **금요일 12:30** (`30 12 * * 5`)

---

## 기타

### 1211회 로또 추천 데이터 삭제
- 테스트 중 중복 저장된 1211회 데이터 정리용 SQL: `docs/migrations/delete-lotto-recommendations-1211.sql`
- 내용: `DELETE FROM lotto_recommendations WHERE target_draw_id = 1211;`
- pgAdmin 또는 psql로 필요 시 실행

---

## 수정·추가된 파일 목록

| 파일 경로 | 변경 내용 |
|-----------|----------|
| `libs/scheduler/src/lib/scheduler.service.ts` | 연금 Cron 3개 시간 변경, 통계 갱신 후 텔레그램 발송, 로또/연금 “이미 데이터 있으면 스킵” 로직, RecommendationRepository·PensionRecommendationRepository 주입, Cron 원래 복구(월/금 12:30) |
| `libs/lotto/.../generate-recommendation.handler.ts` | 통계+AI 모두 만든 뒤 5건 한 번에 저장 |
| `libs/ai/src/lib/ollama.client.ts` | 기본 모델 `llama3.2:latest` |
| `.env.example` | `OLLAMA_MODEL=llama3.2:latest` |
| `docs/migrations/delete-lotto-recommendations-1211.sql` | 신규 — 1211회 추천 삭제용 SQL |
| `docs/devlog_260208.md` | 신규 — 본 개발 일지 (본 문서) |

---

## 스케줄러 개념

### 이 프로젝트에서의 스케줄러
- **역할**: 정해진 요일·시간에 “로또/연금 추천 생성 → 텔레그램 발송”, “당첨 결과 확인”, “DB 동기화” 등을 **자동 실행**.
- **위치**: `libs/scheduler` (NestJS `@nestjs/schedule` 사용).
- **실행 조건**: **API 서버가 떠 있을 때만** 동작. `npm run start`(또는 `nx serve api`)로 띄운 **한 프로세스 안**에서 Cron이 돌아감.

### Cron 표현식 (분 시 일 월 요일)
- 형식: `분 시 일 월 요일` (공백 구분). 요일: **0=일요일, 1=월, …, 6=토**.
- 예: `30 12 * * 1` → 매주 **월요일 12:30** (한국 시간).
- 타임존: `timeZone: 'Asia/Seoul'` 로 지정해 두었음.

### 동작 방식
1. **ScheduleModule.forRoot()**: 앱 기동 시 스케줄러 활성화.
2. **@Cron(표현식, { name, timeZone })**: 해당 표현식에 맞는 시각이 되면 **그 메서드**가 한 번 실행됨.
3. **같은 시각에 여러 Cron**: 같은 분에 여러 개가 있으면 **정의된 순서대로** 실행됨. 서로 다른 작업이면 보통 순차 실행.
4. **실패 시**: 해당 작업만 `catch`에서 로그 남기고 끝. 다른 Cron 작업에는 영향 없음.

### 주의사항
- 서버를 **끄면** 그 시간대 Cron은 실행되지 않음 (해당 시각에 서버가 꺼져 있으면 그 작업은 실행되지 않음).
- 포트 충돌(EADDRINUSE)로 서버가 안 떠 있으면 스케줄도 안 돌아감. `netstat -ano | findstr :3000` → `taskkill /PID <pid> /F` 후 재시작.

---

## 참고 사항

- 스케줄러는 API 서버(`npm run start` / `nx serve api`)가 떠 있는 동안에만 동작함. 서버 중지 시 해당 시간대 작업은 실행되지 않음.
- 로또/연금 추천 Cron은 원래 요일·시간(월 12:30, 금 12:30)으로 복구해 두었음.
- 수동으로 먼저 추천 넣어 두면 해당 회차에 대해서는 스케줄러가 스킵함.
