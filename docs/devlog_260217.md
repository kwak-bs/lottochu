# Lottochu 개발 일지 - 2026.02.17

## 오늘의 목표
- PostgreSQL 로컬 연결 오류(connection timeout) 해결
- 이후 직접 로컬에서 Postgres를 실행할 수 있도록 방법 정리

---

## 현상: connection timeout expired

pgAdmin(또는 다른 DB 클라이언트)에서 `localhost:5432`로 접속 시:

```
connection timeout expired
Multiple connection attempts failed. All failures were:
- host: 'localhost', port: '5432', hostaddr: '::1': connection timeout expired
- host: 'localhost', port: '5432', hostaddr: '127.0.0.1': connection timeout expired
```

- **원인**: 비밀번호 문제가 아니라 **PostgreSQL 서버 프로세스가 떠 있지 않음**.  
  즉, 5432 포트에 아무도 리스닝하지 않는 상태.

---

## 원인 확인

- `netstat` / `Test-NetConnection -Port 5432` → 5432 리스닝 없음
- Docker 미사용
- `C:\Program Files\PostgreSQL\17` 설치 확인 (bin, data 폴더 존재)
- Windows 서비스에서 PostgreSQL 서비스가 없거나 중지 상태일 수 있음

→ **로컬에 PostgreSQL 17은 설치돼 있으나, 현재 실행 중이 아니었음.**

---

## 해결: pg_ctl로 서버 수동 시작

Windows 서비스 대신, 설치된 바이너리로 직접 서버를 띄움.

### 시작 (PowerShell)

```powershell
& 'C:\Program Files\PostgreSQL\17\bin\pg_ctl.exe' -D 'C:\Program Files\PostgreSQL\17\data' -l 'C:\Program Files\PostgreSQL\17\data\server.log' start
```

### 시작 (CMD)

```cmd
"C:\Program Files\PostgreSQL\17\bin\pg_ctl.exe" -D "C:\Program Files\PostgreSQL\17\data" -l "C:\Program Files\PostgreSQL\17\data\server.log" start
```

- **-D**: 데이터 디렉터리(DB 파일 위치)
- **-l**: 서버 로그를 쓸 파일
- 실행 후 잠시 기다리면 "서버가 시작되었습니다" 메시지와 함께 5432 포트 리스닝

### 종료 (PowerShell)

```powershell
& 'C:\Program Files\PostgreSQL\17\bin\pg_ctl.exe' -D 'C:\Program Files\PostgreSQL\17\data' stop
```

### 종료 (CMD)

```cmd
"C:\Program Files\PostgreSQL\17\bin\pg_ctl.exe" -D "C:\Program Files\PostgreSQL\17\data" stop
```

---

## 확인

- `Test-NetConnection -ComputerName 127.0.0.1 -Port 5432` → **TcpTestSucceeded = True**
- `netstat -ano | findstr :5432` → **LISTENING** 확인
- pgAdmin에서 동일 호스트/포트로 접속 시 타임아웃 없이 비밀번호 입력 단계까지 진행 가능

---

## 참고

- **로그**: `C:\Program Files\PostgreSQL\17\data\server.log` 에 쌓임. 에러 발생 시 여기 확인.
- **재부팅 후**: PC를 껐다 켜면 Postgres는 자동으로 안 뜨므로, 필요할 때마다 위 **시작** 명령을 다시 실행하면 됨.
- 상세한 수동 시작 방법은 `docs/start-postgresql.md` 참고.

---

## 수동 실행: 최신 결과 저장 + 다음 회차 추천 생성 + 텔레그램 발송

PostgreSQL과 API 서버가 정상 기동된 상태에서, 수동 트리거 엔드포인트를 호출해
**로또/연금 최신 회차 결과 저장 및 텔레그램 발송**, **다음 회차 추천 생성 및 텔레그램 발송**을 진행.

### 사전 확인

- API 서버: `http://127.0.0.1:3000` (Nest 앱 기동, 3000 LISTENING)
- 현재 DB 상태:
  - 로또: `latestDrawId=1210` (`GET /lotto/status`)
  - 연금: `latestDrawId=301` (`GET /pension/status`)

### 실행한 요청 (curl)

```cmd
curl -s http://127.0.0.1:3000/lotto/status
curl -s http://127.0.0.1:3000/pension/status

curl -s -X POST http://127.0.0.1:3000/lotto/result/check-and-send
curl -s -X POST http://127.0.0.1:3000/pension/result/check-and-send

curl -s -X POST http://127.0.0.1:3000/lotto/recommend/send
curl -s -X POST http://127.0.0.1:3000/pension/recommend/send
```

### 결과

- 로또
  - `POST /lotto/result/check-and-send` → `{"ok":true,"drawId":1211,"sent":true}`
  - `POST /lotto/recommend/send` → `{"ok":true,"targetDrawId":1212,"sent":true}`
- 연금
  - `POST /pension/result/check-and-send` → `{"ok":true,"drawId":301,"sent":false,"message":"No recommendations for draw #301"}`
    - 301회차 추천 데이터가 없어서 결과 비교/발송할 내용이 없어 스킵됨
  - `POST /pension/recommend/send` → `{"ok":true,"targetDrawId":302,"sent":true}`

---

## 수정·추가된 파일 목록

| 파일 경로 | 변경 내용 |
|-----------|----------|
| `docs/start-postgresql.md` | 방법 3(pg_ctl)에 로그 경로(-l), PowerShell/CMD 예시, 종료 명령 추가 |
| `docs/devlog_260217.md` | 신규 — 본 개발 일지 (PostgreSQL 로컬 수동 실행) |
